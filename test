CREATE TABLE UNSUBSCRIBE_FEEDBACK (
  ID                 VARCHAR2(36) NOT NULL,
  CONTACT_ID          VARCHAR2(64),
  EMAIL              VARCHAR2(320) NOT NULL,
  SOURCE             VARCHAR2(20)  NOT NULL,     -- 'BULK' or 'MMC'
  REASON             VARCHAR2(2000),

  CREATED_BY          VARCHAR2(128),
  CREATED_DATE        TIMESTAMP(6),
  LAST_MODIFIED_BY    VARCHAR2(128),
  LAST_MODIFIED_DATE  TIMESTAMP(6),

  CONSTRAINT PK_UNSUBSCRIBE_FEEDBACK PRIMARY KEY (ID),
  CONSTRAINT CK_UNSUB_FBK_SOURCE CHECK (SOURCE IN ('BULK','MMC'))
);

CREATE INDEX IDX_UNSUB_FBK_EMAIL ON UNSUBSCRIBE_FEEDBACK (EMAIL);
CREATE INDEX IDX_UNSUB_FBK_CONTACT ON UNSUBSCRIBE_FEEDBACK (CONTACT_ID);
CREATE INDEX IDX_UNSUB_FBK_LMD ON UNSUBSCRIBE_FEEDBACK (LAST_MODIFIED_DATE);


package com.bnpparibas.gmrc.evolution.interest_manager_service.unsubscribe;

import com.bnpparibas.gmrc.evolution.starter.data.model.AbstractAuditEntity;
import jakarta.persistence.*;

@Entity
@Table(name = "UNSUBSCRIBE_FEEDBACK")
public class UnsubscribeFeedback extends AbstractAuditEntity {

  @Column(name = "CONTACT_ID", length = 64)
  private String contactId;

  @Column(name = "EMAIL", nullable = false, length = 320)
  private String email;

  @Column(name = "SOURCE", nullable = false, length = 20)
  private String source; // BULK | MMC

  @Column(name = "REASON", length = 2000)
  private String reason;

  public String getContactId() { return contactId; }
  public void setContactId(String contactId) { this.contactId = contactId; }

  public String getEmail() { return email; }
  public void setEmail(String email) { this.email = email; }

  public String getSource() { return source; }
  public void setSource(String source) { this.source = source; }

  public String getReason() { return reason; }
  public void setReason(String reason) { this.reason = reason; }
}

package com.bnpparibas.gmrc.evolution.interest_manager_service.unsubscribe;

public class UnsubscribeFeedbackRequest {
  private String contactId;
  private String email;
  private String source;     // BULK | MMC
  private String reason;     // optional

  public String getContactId() { return contactId; }
  public void setContactId(String contactId) { this.contactId = contactId; }

  public String getEmail() { return email; }
  public void setEmail(String email) { this.email = email; }

  public String getSource() { return source; }
  public void setSource(String source) { this.source = source; }

  public String getReason() { return reason; }
  public void setReason(String reason) { this.reason = reason; }
}



package com.bnpparibas.gmrc.evolution.interest_manager_service.unsubscribe;

import java.util.Date;

public class UnsubscribeFeedbackResponse {
  private String id;
  private String contactId;
  private String email;
  private String source;
  private String reason;

  private String createdBy;
  private Date createdDate;
  private String lastModifiedBy;
  private Date lastModifiedDate;

  public UnsubscribeFeedbackResponse(UnsubscribeFeedback e) {
    this.id = e.getId();
    this.contactId = e.getContactId();
    this.email = e.getEmail();
    this.source = e.getSource();
    this.reason = e.getReason();

    this.createdBy = e.getCreatedBy();
    this.createdDate = e.getCreatedDate();
    this.lastModifiedBy = e.getLastModifiedBy();
    this.lastModifiedDate = e.getLastModifiedDate();
  }

  public String getId() { return id; }
  public String getContactId() { return contactId; }
  public String getEmail() { return email; }
  public String getSource() { return source; }
  public String getReason() { return reason; }
  public String getCreatedBy() { return createdBy; }
  public Date getCreatedDate() { return createdDate; }
  public String getLastModifiedBy() { return lastModifiedBy; }
  public Date getLastModifiedDate() { return lastModifiedDate; }
}

package com.bnpparibas.gmrc.evolution.interest_manager_service.unsubscribe;

import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface UnsubscribeFeedbackRepository extends JpaRepository<UnsubscribeFeedback, String> {
  List<UnsubscribeFeedback> findByEmailOrderByCreatedDateDesc(String email);
  List<UnsubscribeFeedback> findByContactIdOrderByCreatedDateDesc(String contactId);
}



package com.bnpparibas.gmrc.evolution.interest_manager_service.unsubscribe;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
public class UnsubscribeFeedbackService {

  private final UnsubscribeFeedbackRepository repo;

  public UnsubscribeFeedbackService(UnsubscribeFeedbackRepository repo) {
    this.repo = repo;
  }

  @Transactional
  public UnsubscribeFeedback create(UnsubscribeFeedbackRequest req) {
    if (req.getEmail() == null || req.getEmail().trim().isEmpty()) {
      throw new IllegalArgumentException("email is required");
    }
    if (req.getSource() == null || req.getSource().trim().isEmpty()) {
      throw new IllegalArgumentException("source is required");
    }

    String source = req.getSource().trim().toUpperCase();
    if (!source.equals("BULK") && !source.equals("MMC")) {
      throw new IllegalArgumentException("source must be BULK or MMC");
    }

    UnsubscribeFeedback e = new UnsubscribeFeedback();
    e.setContactId(req.getContactId() != null ? req.getContactId().trim() : null);
    e.setEmail(req.getEmail().trim());
    e.setSource(source);
    e.setReason(req.getReason() != null ? req.getReason().trim() : null);

    return repo.save(e);
  }

  @Transactional(readOnly = true)
  public List<UnsubscribeFeedback> getByEmail(String email) {
    if (email == null || email.trim().isEmpty()) {
      throw new IllegalArgumentException("email is required");
    }
    return repo.findByEmailOrderByCreatedDateDesc(email.trim());
  }

  @Transactional(readOnly = true)
  public List<UnsubscribeFeedback> getByContactId(String contactId) {
    if (contactId == null || contactId.trim().isEmpty()) {
      throw new IllegalArgumentException("contactId is required");
    }
    return repo.findByContactIdOrderByCreatedDateDesc(contactId.trim());
  }
}

package com.bnpparibas.gmrc.evolution.interest_manager_service.unsubscribe;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/unsubscribe/feedback")
public class UnsubscribeFeedbackController {

  private final UnsubscribeFeedbackService service;

  public UnsubscribeFeedbackController(UnsubscribeFeedbackService service) {
    this.service = service;
  }

  @PostMapping
  public ResponseEntity<UnsubscribeFeedbackResponse> create(@RequestBody UnsubscribeFeedbackRequest req) {
    UnsubscribeFeedback saved = service.create(req);
    return ResponseEntity.ok(new UnsubscribeFeedbackResponse(saved));
  }

  // GET /api/unsubscribe/feedback?email=a@b.com
  @GetMapping(params = "email")
  public ResponseEntity<List<UnsubscribeFeedbackResponse>> getByEmail(@RequestParam("email") String email) {
    List<UnsubscribeFeedbackResponse> out = service.getByEmail(email)
        .stream().map(UnsubscribeFeedbackResponse::new).toList();
    return ResponseEntity.ok(out);
  }

  // GET /api/unsubscribe/feedback?contactId=ECO-UPE4E
  @GetMapping(params = "contactId")
  public ResponseEntity<List<UnsubscribeFeedbackResponse>> getByContactId(@RequestParam("contactId") String contactId) {
    List<UnsubscribeFeedbackResponse> out = service.getByContactId(contactId)
        .stream().map(UnsubscribeFeedbackResponse::new).toList();
    return ResponseEntity.ok(out);
  }
}








