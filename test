CREATE TABLE UNSUBSCRIBE_FEEDBACK (
  ID               NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
  CONTACT_ID        VARCHAR2(64),
  EMAIL             VARCHAR2(320) NOT NULL,
  SOURCE            VARCHAR2(20)  NOT NULL,  -- 'BULK' or 'MMC'
  REASON            VARCHAR2(2000),
  CREATED_BY        VARCHAR2(128) NOT NULL,
  CREATED_DATE      TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  CONSTRAINT PK_UNSUBSCRIBE_FEEDBACK PRIMARY KEY (ID),
  CONSTRAINT CK_UNSUB_SRC CHECK (SOURCE IN ('BULK','MMC'))
);

CREATE INDEX IDX_UNSUB_FBK_EMAIL ON UNSUBSCRIBE_FEEDBACK (EMAIL);
CREATE INDEX IDX_UNSUB_FBK_CONTACT ON UNSUBSCRIBE_FEEDBACK (CONTACT_ID);
CREATE INDEX IDX_UNSUB_FBK_CREATED_DATE ON UNSUBSCRIBE_FEEDBACK (CREATED_DATE);


package com.yourcompany.gmrc.unsubscribe;

import jakarta.persistence.*;
import java.time.Instant;

@Entity
@Table(name = "UNSUBSCRIBE_FEEDBACK")
public class UnsubscribeFeedbackEntity {

  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY) // works for Oracle IDENTITY
  // If you use sequence+trigger, you can keep this OR remove @GeneratedValue and let trigger fill ID.
  @Column(name = "ID")
  private Long id;

  @Column(name = "CONTACT_ID")
  private String contactId;

  @Column(name = "EMAIL", nullable = false, length = 320)
  private String email;

  @Column(name = "SOURCE", nullable = false, length = 20)
  private String source; // BULK | MMC

  @Column(name = "REASON", length = 2000)
  private String reason;

  @Column(name = "CREATED_BY", nullable = false, length = 128)
  private String createdBy;

  @Column(name = "CREATED_DATE", nullable = false)
  private Instant createdDate;

  @PrePersist
  public void prePersist() {
    if (createdDate == null) createdDate = Instant.now();
  }

  // getters/setters
  public Long getId() { return id; }

  public String getContactId() { return contactId; }
  public void setContactId(String contactId) { this.contactId = contactId; }

  public String getEmail() { return email; }
  public void setEmail(String email) { this.email = email; }

  public String getSource() { return source; }
  public void setSource(String source) { this.source = source; }

  public String getReason() { return reason; }
  public void setReason(String reason) { this.reason = reason; }

  public String getCreatedBy() { return createdBy; }
  public void setCreatedBy(String createdBy) { this.createdBy = createdBy; }

  public Instant getCreatedDate() { return createdDate; }
  public void setCreatedDate(Instant createdDate) { this.createdDate = createdDate; }
}




package com.yourcompany.gmrc.unsubscribe;

public class UnsubscribeFeedbackRequest {
  private String contactId;
  private String email;
  private String source;       // BULK | MMC
  private String reason;       // optional
  private String createdBy;    // from controller

  public String getContactId() { return contactId; }
  public void setContactId(String contactId) { this.contactId = contactId; }

  public String getEmail() { return email; }
  public void setEmail(String email) { this.email = email; }

  public String getSource() { return source; }
  public void setSource(String source) { this.source = source; }

  public String getReason() { return reason; }
  public void setReason(String reason) { this.reason = reason; }

  public String getCreatedBy() { return createdBy; }
  public void setCreatedBy(String createdBy) { this.createdBy = createdBy; }
}



package com.yourcompany.gmrc.unsubscribe;

import java.time.Instant;

public class UnsubscribeFeedbackResponse {
  private Long id;
  private String contactId;
  private String email;
  private String source;
  private String reason;
  private String createdBy;
  private Instant createdDate;

  public UnsubscribeFeedbackResponse(UnsubscribeFeedbackEntity e) {
    this.id = e.getId();
    this.contactId = e.getContactId();
    this.email = e.getEmail();
    this.source = e.getSource();
    this.reason = e.getReason();
    this.createdBy = e.getCreatedBy();
    this.createdDate = e.getCreatedDate();
  }

  public Long getId() { return id; }
  public String getContactId() { return contactId; }
  public String getEmail() { return email; }
  public String getSource() { return source; }
  public String getReason() { return reason; }
  public String getCreatedBy() { return createdBy; }
  public Instant getCreatedDate() { return createdDate; }
}


package com.yourcompany.gmrc.unsubscribe;

import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;

public interface UnsubscribeFeedbackRepository extends JpaRepository<UnsubscribeFeedbackEntity, Long> {
  List<UnsubscribeFeedbackEntity> findByEmailOrderByCreatedDateDesc(String email);
  List<UnsubscribeFeedbackEntity> findByContactIdOrderByCreatedDateDesc(String contactId);
}


package com.yourcompany.gmrc.unsubscribe;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
public class UnsubscribeFeedbackService {

  private final UnsubscribeFeedbackRepository repo;

  public UnsubscribeFeedbackService(UnsubscribeFeedbackRepository repo) {
    this.repo = repo;
  }

  @Transactional
  public UnsubscribeFeedbackEntity create(UnsubscribeFeedbackRequest req) {
    if (req.getEmail() == null || req.getEmail().trim().isEmpty()) {
      throw new IllegalArgumentException("email is required");
    }
    if (req.getSource() == null || req.getSource().trim().isEmpty()) {
      throw new IllegalArgumentException("source is required");
    }
    if (req.getCreatedBy() == null || req.getCreatedBy().trim().isEmpty()) {
      throw new IllegalArgumentException("createdBy is required");
    }

    String source = req.getSource().trim().toUpperCase();
    if (!source.equals("BULK") && !source.equals("MMC")) {
      throw new IllegalArgumentException("source must be BULK or MMC");
    }

    UnsubscribeFeedbackEntity e = new UnsubscribeFeedbackEntity();
    e.setContactId(req.getContactId() != null ? req.getContactId().trim() : null);
    e.setEmail(req.getEmail().trim());
    e.setSource(source);
    e.setReason(req.getReason() != null ? req.getReason().trim() : null);
    e.setCreatedBy(req.getCreatedBy().trim());

    return repo.save(e);
  }

  @Transactional(readOnly = true)
  public List<UnsubscribeFeedbackEntity> getByEmail(String email) {
    if (email == null || email.trim().isEmpty()) {
      throw new IllegalArgumentException("email is required");
    }
    return repo.findByEmailOrderByCreatedDateDesc(email.trim());
  }

  @Transactional(readOnly = true)
  public List<UnsubscribeFeedbackEntity> getByContactId(String contactId) {
    if (contactId == null || contactId.trim().isEmpty()) {
      throw new IllegalArgumentException("contactId is required");
    }
    return repo.findByContactIdOrderByCreatedDateDesc(contactId.trim());
  }
}



package com.yourcompany.gmrc.unsubscribe;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/unsubscribe/feedback")
public class UnsubscribeFeedbackController {

  private final UnsubscribeFeedbackService service;

  public UnsubscribeFeedbackController(UnsubscribeFeedbackService service) {
    this.service = service;
  }

  /**
   * POST /api/unsubscribe/feedback
   * Body:
   * {
   *   "contactId": "ECO-UPE4E",
   *   "email": "user@bank.com",
   *   "source": "MMC",
   *   "reason": "Too many emails",
   *   "createdBy": "Portal-ECO-UPE4E"
   * }
   */
  @PostMapping
  public ResponseEntity<UnsubscribeFeedbackResponse> create(@RequestBody UnsubscribeFeedbackRequest req) {
    UnsubscribeFeedbackEntity saved = service.create(req);
    return ResponseEntity.ok(new UnsubscribeFeedbackResponse(saved));
  }

  /**
   * GET /api/unsubscribe/feedback?email=user@bank.com
   */
  @GetMapping(params = "email")
  public ResponseEntity<List<UnsubscribeFeedbackResponse>> getByEmail(@RequestParam("email") String email) {
    List<UnsubscribeFeedbackResponse> out = service.getByEmail(email)
        .stream().map(UnsubscribeFeedbackResponse::new).toList();
    return ResponseEntity.ok(out);
  }

  /**
   * GET /api/unsubscribe/feedback?contactId=ECO-UPE4E
   */
  @GetMapping(params = "contactId")
  public ResponseEntity<List<UnsubscribeFeedbackResponse>> getByContactId(@RequestParam("contactId") String contactId) {
    List<UnsubscribeFeedbackResponse> out = service.getByContactId(contactId)
        .stream().map(UnsubscribeFeedbackResponse::new).toList();
    return ResponseEntity.ok(out);
  }
}
