import { Component, OnInit } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { ContentUnsubscribeService } from '../service/content-unsubscribe.service';

type SourceType = 'BULK' | 'MMC' | '';

@Component({
  selector: 'app-content-unsubscribe',
  templateUrl: './content-unsubscribe.component.html',
  styleUrls: ['./content-unsubscribe.component.scss']
})
export class ContentUnsubscribeComponent implements OnInit {

  public email: string = '';
  public contactId: string = '';
  public source: SourceType = '';

  public pageLoading: boolean = true;

  public isSubmitLoading: boolean = false;

  public isSaved: boolean = false;                // success
  public alreadyUnsubscribed: boolean = false;    // already
  public isError: boolean = false;
  public errorMsg: string = '';

  constructor(
    private readonly activatedRoute: ActivatedRoute,
    private readonly contentUnsubscribeService: ContentUnsubscribeService
  ) {}

  public ngOnInit(): void {
    this.activatedRoute.queryParams.subscribe((params) => {
      this.email = (params && params.email) ? String(params.email) : '';
      this.contactId = (params && params.contactId) ? String(params.contactId) : '';
      this.source = (params && params.source) ? (String(params.source).toUpperCase() as SourceType) : '';

      // Basic validation (you can relax if needed)
      if (!this.contactId || !this.source) {
        this.pageLoading = false;
        this.isError = true;
        this.errorMsg = 'Missing contactId/source. Please use the unsubscribe link from the email.';
        return;
      }

      // optional: if source is not BULK/MMC, block
      if (this.source !== 'BULK' && this.source !== 'MMC') {
        this.pageLoading = false;
        this.isError = true;
        this.errorMsg = 'Invalid source. Please use the unsubscribe link from the email.';
        return;
      }

      // Check if already unsubscribed -> if yes show message and stop
      this.checkAlreadyUnsubscribed();
    });
  }

  private checkAlreadyUnsubscribed(): void {
    this.pageLoading = true;
    this.isError = false;
    this.errorMsg = '';

    this.contentUnsubscribeService.checkAlreadyUnsubscribed(this.contactId, this.source)
      .subscribe(
        (res: any) => {
          // You choose response format; support both:
          // { alreadyUnsubscribed: true } OR { status: 'ALREADY_UNSUBSCRIBED' }
          const already =
            (res && res.alreadyUnsubscribed === true) ||
            (res && res.status === 'ALREADY_UNSUBSCRIBED');

          this.alreadyUnsubscribed = !!already;
          this.pageLoading = false;
        },
        () => {
          // If check endpoint fails, you can still allow form (or block).
          // I'd allow form but show a warning.
          this.pageLoading = false;
          this.alreadyUnsubscribed = false;
        }
      );
  }

  public getSourceLabel(): string {
    if (this.source === 'BULK') return 'Bulk distribution email';
    if (this.source === 'MMC') return 'MMC email';
    return '';
  }

  public submitUnsubscribe(emailTxt: string, reasonTxt: string): void {
    // reset messages
    this.isError = false;
    this.errorMsg = '';

    const email = (emailTxt || '').trim();
    const reason = (reasonTxt || '').trim();

    if (!email || !this.isValidEmail(email)) {
      this.isError = true;
      this.errorMsg = 'Please enter a valid email address.';
      return;
    }

    if (!this.contactId || !this.source) {
      this.isError = true;
      this.errorMsg = 'Missing contactId/source. Please use the unsubscribe link from the email.';
      return;
    }

    this.isSubmitLoading = true;

    // 1) Unsubscribe (remove channel etc)
    this.contentUnsubscribeService.unsubscribe(this.contactId, this.source, email)
      .subscribe(
        (unsubRes: any) => {
          // If backend says already unsubscribed, show already message
          const already =
            (unsubRes && unsubRes.status === 'ALREADY_UNSUBSCRIBED') ||
            (unsubRes && unsubRes.alreadyUnsubscribed === true);

          if (already) {
            this.isSubmitLoading = false;
            this.alreadyUnsubscribed = true;
            return;
          }

          // 2) Save feedback (audit)
          this.contentUnsubscribeService.saveFeedback({
            contactId: this.contactId,
            email,
            source: this.source,
            reason
          }).subscribe(
            () => {
              this.isSubmitLoading = false;
              this.isSaved = true;
            },
            () => {
              // even if feedback save fails, the unsubscribe is done -> show success but warn
              this.isSubmitLoading = false;
              this.isSaved = true;
            }
          );
        },
        () => {
          this.isSubmitLoading = false;
          this.isError = true;
          this.errorMsg = 'Something went wrong. Please try again later.';
        }
      );
  }

  private isValidEmail(value: string): boolean {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test((value || '').trim());
  }
}



<div class="content-unsubscribe">
  <div class="unsubscribe-page">

    <!-- LOADING -->
    <div *ngIf="pageLoading" class="loader c-align"></div>

    <!-- ERROR -->
    <div *ngIf="!pageLoading && isError" class="error-msg c-align">{{ errorMsg }}</div>

    <!-- ALREADY UNSUBSCRIBED -->
    <div *ngIf="!pageLoading && !isError && alreadyUnsubscribed" class="thanks-section">
      <div class="thanks-txt">You have already unsubscribed.</div>
      <div class="sub-txt" *ngIf="getSourceLabel()">Request from: <b>{{ getSourceLabel() }}</b></div>
    </div>

    <!-- SUCCESS -->
    <div *ngIf="!pageLoading && !isError && isSaved" class="thanks-section">
      <div class="thanks-txt">You have successfully unsubscribed.</div>
      <div class="sub-txt" *ngIf="getSourceLabel()">Request from: <b>{{ getSourceLabel() }}</b></div>
    </div>

    <!-- FORM -->
    <div *ngIf="!pageLoading && !isError && !alreadyUnsubscribed && !isSaved" class="content-unsubscribe-container">

      <div class="header-txt">Unsubscribe</div>

      <div class="source-txt" *ngIf="getSourceLabel()">
        Request from: <b>{{ getSourceLabel() }}</b>
      </div>

      <div class="field-section">
        <div class="field-label">Email Address *</div>
        <!-- Use template ref like feedback page -->
        <input
          #emailTxt
          class="txt-field"
          type="text"
          [value]="email"
          readonly />
      </div>

      <div class="field-section">
        <div class="field-label">Reason for Unsubscribe (optional)</div>
        <textarea #reasonTxt class="txt-area"></textarea>
      </div>

      <!-- show error close to form -->
      <div *ngIf="isError" class="error-msg">{{ errorMsg }}</div>

      <div class="btn-section">
        <button
          class="submit-btn"
          [disabled]="isSubmitLoading"
          (click)="submitUnsubscribe(emailTxt.value, reasonTxt.value)">
          Submit
        </button>

        <div *ngIf="isSubmitLoading" class="loader c-align"></div>
      </div>
    </div>

  </div>
</div>

.content-unsubscribe {
  .unsubscribe-page {
    width: 100%;
    padding: 30px 0;
  }

  .content-unsubscribe-container {
    width: 700px;
    max-width: calc(100% - 40px);
    margin: 0 auto;
  }

  .header-txt {
    font-size: 28px;
    text-align: center;
    margin-bottom: 18px;
    font-weight: 600;
  }

  .source-txt {
    text-align: center;
    margin-bottom: 20px;
  }

  .field-section {
    margin-bottom: 16px;
  }

  .field-label {
    font-weight: 600;
    margin-bottom: 6px;
  }

  .txt-field {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .txt-area {
    width: 100%;
    min-height: 120px;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .btn-section {
    margin-top: 18px;
  }

  .submit-btn {
    display: inline-block;
    padding: 10px 18px;
    border-radius: 4px;
    border: 1px solid #2a2a2a;
    background: #2a2a2a;
    color: #fff;
    cursor: pointer;
  }

  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .error-msg {
    color: #b00020;
    margin: 10px 0;
  }

  .thanks-section {
    width: 700px;
    max-width: calc(100% - 40px);
    margin: 0 auto;
    text-align: center;
    padding: 30px 0;
  }

  .thanks-txt {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .sub-txt {
    opacity: 0.85;
  }

  .c-align {
    margin: 10px auto;
  }

  .loader {
    width: 26px;
    height: 26px;
    border: 3px solid #ccc;
    border-top-color: #2a2a2a;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
}

import { Injectable } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';

@Injectable()
export class ContentUnsubscribeService {

  constructor(private readonly http: HttpClient) {}

  // GET /api/unsubscribe/check?contactId=...&source=...
  public checkAlreadyUnsubscribed(contactId: string, source: string): Observable<any> {
    const params = new HttpParams()
      .set('contactId', contactId)
      .set('source', source);

    return this.http.get('/api/unsubscribe/check', { params });
  }

  // POST /api/unsubscribe
  // body: { contactId, source, email }
  public unsubscribe(contactId: string, source: string, email: string): Observable<any> {
    return this.http.post('/api/unsubscribe', { contactId, source, email });
  }

  // POST /api/unsubscribe/feedback
  public saveFeedback(body: { contactId: string; email: string; source: string; reason?: string }): Observable<any> {
    return this.http.post('/api/unsubscribe/feedback', body);
  }
}

